## 1.报文的流动

HTTP报文是指在HTTP应用程序之间收发的数据块。其以文本形式的元信息开头，描述报文的内容和含义，而后接续可选部分。这里有三个术语：

- 流入（inbound）
- 流出（outbound）
- 事务处理（transaction）

流入是指从客户端到服务器的事务处理方向；而流出则是从服务器到客户端的事务处理方向。但不管是哪种流动，所有报文都向下（downstream）流动，而报文的发送者都在接受者的上游（upstream）。注意，这里的上游和下游都只和发送者、接受者有关，而服务器和客户端都是下游节点，所以我们无法区别报文的发送方向。

## 2.报文的组成部分

HTTP报文分请求报文和响应报文两种，它们都由三个部分组成：

- 起始行：对报文进行描述。
- 首部：包含属性
- 主体：可选的，包含数据。

起始行和首部是由行分隔的ASCII文本，都包括了一个回车符和一个换行符，可写作CRLF。但是，由于部分HTTP应用程序不总是发送CRLF，所以一个HTTP应用程序应该接受单个换行符作为终止。主体可以包含文本或者二进制数据，也可以为空。

### 请求报文
```
<method> <request-URL> <version>
<headers>

<entity-body>
```
### 响应报文
与请求报文相比，只有起始行不同

```
<version> <status> <reason-phrase>
<headers>

<entity-body>
```
接下来将对其中的大部分内容进行详细介绍，而实体则在日后详谈。这里简述下实体<entity-body>：包含一个由任意数据组成的数据块，是可选的。

## 3.起始行详解
起始行分为请求行和响应行。

### 3.1.请求行

请求报文的起始行，包含一个方法和一个请求URL。方法描述需要执行的操作，而请求URL则描述操作对象。请求行还包含客户端的HTTP协议版本。这些字段使用空格符" "分隔。注意，在HTTP/0.9不要求请求中包含HTTP版本号。

### 3.2.响应行

响应报文的起始行，包含响应报文使用的HTTP协议版本、数字状态码和原因短语。所有字段使用空格符" "分隔。

### 3.3.方法

告知服务器要进行的操作。HTTP规范中描述了一组方法，而在HTTP规范之外的方法，则是扩展方法，是HTTP规范的拓展。常用HTTP方法有：


```
方法	描述	是否包含主体
GET	从服务器中获取文档	否
HEAD	从服务器获取文档首部	否
POST	向服务器发送需要处理的数据	是
PUT	将请求的主体存储在服务器上	是
TRACE	对可能经过代理服务传送到服务器上的报文进行追踪	否
OPTIONS	查询服务器支持的方法	否
DELETE	从服务器上删除文档	否
```

### 3.4.状态码

服务器对客户端操作结果的回应。状态码有五种分类，而当前HTTP版本只规定了其中一部分。如果接收到拓展的状态码，则会按照其所属范围进行分类，而后按照该分类中的普通成员处理。状态码分类如下：


```
整体范围	已定义范围	分类
100~199	100、101	信息提示
200~299	200~206	成功
300~399	300~305	重定向
400~499	400~415	客户端错误
500~599	500~505	服务器错误
```

后面会解释当前使用的所有状态码，这里按下不表。

### 3.5.原因短语

与状态码同时出现，是其文本形式，但是HTTP规范对此并没有任何规定,但是有推荐的文本内容。

### 3.6.版本号

以HTTPx.y出现,使得HTTP客户端和服务器可以了解双方的能力和报文。注意，其版本号不会被当作小数处理，每一个数字都会单独比较。

## 4.其他部分
### 4.1.首部
其作用是向报文添加附加信息，本质上是名/值对的列表，用冒号":"分开名与值，可以分为五种：通用首部、请求首部、响应首部、实体首部和扩展首部。首部的语法如下：
<headers>: (可选的空格)<value>\r\n
首部可以有多行，为了增强可读性，从第二行开始要在前面加一个空格或者制表符。

### 4.2.实体的主体部分
是HTTP报文的符合，即其要传输的内容。HTTP报文可以承载多种类型的数字数据，包括HTML文档、图片、视频等。

### 4.3.HTTP0.9的报文
这是HTTP协议早期版本，由请求和响应构成，但是请求中只包含方法和请求URL，而响应中只包含实体。由于其却放灵活性，不能使用大部分提到的方法，但是在部分应用上仍旧使用，开发者应该清楚其局限。

## 5.方法
这部分是对前面的基本方法的深入探讨。有以下几点要注意：

并不是每个服务器实现了所有方法
服务器中部分方法的使用可能是受限的，而限制则在服务器的配置中进行设置。
### 5.1.安全方法
这是由HTTP协议定义的，其中包括GET和HEAD方法。安全方法意味着不产生动作，但这由Web开发者决定。相对应的，使用不安全的方法时，会允许HTTP应用开发者通知用户，这才是目的。

### 5.2.GET方法
常用方法，用于请求服务器发送某个资源，在HTTP/1.1中，要求服务器实现该方法。请求参数放在URL中。

### 5.3.HEAD方法
类似GET方法，但是响应只返回首部。目的是允许客户端对资源的首部进行检查。该方法有以下作用：

- 不获取资源的前提下了解资源情况
- 查看对象是否存在
- 测试资源是否被修改
- 规范要求其返回的首部于GET方法获得的相同。

### 5.4.PUT方法
向服务器写入文档，其方法的语义即让服务器用请求的主体部分（body）创建或者覆盖所请求的URL命名的新文档。由于其允许用户修改文件，通常要求进行密码认证。该方法需要存储资源。

### 5.5.POST方法
起初用来输入数据，现多用来支持HTTP表单。表单体拿到的数据发送给服务器，再由服务器决定去向。该方法不需要存储资源。请求参数放在请求体中，以key/value形式出现。可以传输文件

### 5.6.TRACE方法
在客户端发起请求以后，当它穿过其他应用程序的中间节点时可能被修改。而TRACE方法允许客户端最后将请求发送给服务器。

该请求会进行“环回”诊断，即在服务器弹回一条携带收到的报文的TRACE响应，使得客户端能查看原始报文的修改情况。TRACE方法用于诊断，验证请求是否穿过了请求/响应链，但由于其假设中间应用程序对各种不同类型的请求的处理相同，所以其不能区别HTTP程序对不同方法的处理机制的差异。

TRACE请求中不能带有实体的主体部分。响应主体则包含收到的请求主体的精确副本。

### 5.7.OPTIONS方法
请求Web服务器告知其支持的所有方法，这些方法是通用于服务器上所有资源的。这使得客户端可以判定请求资源的最优方法。（就是优化）

### 5.8.DELETE方法
请求服务器删除请求URL指定的资源，但是客户端程序不保证删除操作被执行。

### 5.9.拓展方法
由于HTTP被设计为字段可拓展的，新旧特性可以兼容。而拓展方法指的是：没有在HTTP/1.1规范中定义的方法。常见拓展方法实例如下：

```
方法	描述
LOCK	允许用户“锁定”资源，以防编辑时被其他人修改。
MKCOL	允许用户创建资源
COPY	复制服务器上的资源
MOVE	移动服务器的资源
```

上面的拓展方法是在WebDAV HTTP拓展中定义的拓展方法。要注意的是，并非所有拓展方法都可以被理解或者应用，所以，最好对拓展方法宽容以待，只要不破坏端到端行为，可以传递给下游服务器；如果可能破坏，则传递501 Not Implemented进行响应。惯例是：“对发送的内容要求严格，对接受的内容要求宽松”。

## 6.状态码
目的是便利客户端理解事务处理的结果，分为五大类，而五大类中的每个状态码都有一个HTTP/1.1推荐使用的原因短语。

### 6.1.信息性状态码100~199
在HTTP/1.1中引入，存在争论，受到限制。其主要内容如下：



- 状态码	原因短语	含义

- 100	Continue	说明收到请求的初始部分，请客户端继续。发送了这个状态码以后，服务器在收到请求之后必须响应。

- 101	Switching Protocol	说明服务器正在根据客户端的指定，将协议切换成Update首部所列的协议

在这里，要对100状态码进行一个解释。其针对的情境是：客户端需要发送一个实体给服务器，但要在发送之前检查一下服务器是否会接受该实体。而它在客户端、服务器和代理之间是这样通信的:

- 客户端与100状态码

    客户端发送Expect：100Continue请求首部，从而可以在发送实体之前等待100Continue的响应。这用于避免向服务器发送一个无法处理的大实体。注意，如果等待超时，则客户端应该直接发送实体。

- 服务器与100状态码

    服务器在收到Expect：100Continue首部的请求时，应该用100Continue或者其他错误状态码进行响应。

    如果服务器在发送100Continue之前就收到部分实体，即客户端已经超时了，服务器就不需要发送100状态码，但是读完请求以后，应该发送一个最终状态码（可跳过100状态码）。

- 代理与100状态码

    代理收到一个100Continue的Expect请求，则能做的分以下几种情况：

    知道下一跳服务器是HTTP/1.1兼容（或者不知道），则将Except首部向下转发
    知道下一跳服务器只与HTTP/1.1之前兼容，则应该响应417Exception Failed错误（或者是先向客户端返回100Continue，而后在向服务器转发请求的时候，删除Except首部）。


- 服务器101状态码

    服务器已经理解了客户端的请求，并将通过Upgrade（告知客户端采用的协议） 消息头通知客户端采用不同的协议来完成这个请求。在发送完这个响应最后的空行后，服务器将会切换到在Upgrade 消息头中定义的那些协议。

### 6.2.成功状态码200~299
成功的请求有不同类型，所以下面有不同的表示成功的状态码。

- 状态码	原因短语	含义
- 200	OK	请求没问题，实体的主体部分包含请求的资源。

- 201	Created	请求已经被实现，而且有一个新的资源已经依据请求的需要而建立，且其 URI 已经随Location 头信息返回。假如需要的资源无法及时建立的话，应当返回 '202 Accepted'。

- 202	Accepeted	服务器已接受请求，但尚未处理。正如它可能被拒绝一样，最终该请求可能会也可能不会被执行。在异步操作的场合下，没有比发送这个状态码更方便的做法了。

    返回202状态码的响应的目的是允许服务器接受其他过程的请求（例如某个每天只执行一次的基于批处理的操作），而不必让客户端一直保持与服务器的连接直到批处理操作全部完成。在接受请求处理并返回202状态码的响应应当在返回的实体中包含一些指示处理当前状态的信息，以及指向处理状态监视器或状态预测的指针，以便用户能够估计操作是否已经完成。

- 203 Non-Authoritative Information 服务器已成功处理了请求，但返回的信息可能来自另一来源。

- 204	Not Content	响应报文包含首部和状态行，但是没有实体的主体部分。告诉用户已经执行成功，但是不希望用户更新文档视图。

- 205	Reset Content	服务器成功处理了请求，且没有返回任何内容。但是与204响应不同，返回此状态码的响应要求请求者重置文档视图。该响应主要是被用于接受用户输入后，立即重置表单，以便用户能够轻松地开始另一次输入。

    与204响应一样，该响应也被禁止包含任何消息体，且以消息头后的第一个空行结束。

- 206	Partial Content	服务器已经成功处理了部分 GET 请求。类似于 FlashGet 或者迅雷这类的 HTTP下载工具都是使用此类响应实现断点续传或者将一个大文档分解为多个下载段同时下载。

### 6.3.重定向状态码300~399

告知用户使用其他资源替代访问资源。如果资源已移动，则可以发送重定向状态码以及一个可选的Location首部来告知客户端资源已被移动，以及当前位置。

也可以通过重定向状态码验证本地资源与服务器资源，用于查看服务器资源的修改，以及保持本地副本的及时性。

对包含了重定向状态码的非HEAD请求进行响应，则包含一个实体，并在实体中描述信息和指向（多个）重定向URL的连接。


- 状态码	原因短语	含义

- 300	Multiple Choices	客户端请求一个实际上指向多个资源的URL时返回。服务器在返回时，可以在Location首部包含首选URL

- 301	Moved Permanently 资源永久移动，下次访问读取缓存中移动后位置

- 302	Found 类似301，但是Location首部给出的URL只能临时定位资源，之后的请求应使用旧URL而不会从缓存中读取移动后的位置。

- 303	See Other	对于POST请求，它表示请求已经被处理，客户端可以接着使用GET方法去请求Location里的URI。

- 304	Not Modified 自从上次请求后，请求的网页未修改过。服务器返回此响应时，不会返回网页内容。

    如果网页自请求者上次请求后再也没有更改过，您应将服务器配置为返回此响应（称为 If-Modified-Since HTTP 标头）。服务器可以告诉自从上次抓取后网页没有变更，进而节省带宽和开销。

- 305	Use Proxy	请求者只能使用代理访问请求的网页。如果服务器返回此响应，还表示请求者应使用代理。

- 307	Temporary Redirect	对于POST请求，表示请求还没有被处理，客户端应该向Location里的URI重新发起POST请求。


状态码302、303、307之间存在交叉和细微的差别，而其源于HTTP/1.0和HTTP/1.1应用程序之间的差别。

对于HTTP/1.0客户端，发起POST请求并收到302响应时，会接受Location首部的重定向URL，并发送GET请求。

对HTTP/1.0服务器，要求客户端像上面一样做。
但是HTTP/1.1使用303状态码实现相同行为，所以，对于HTTP/1.1客户端，使用307状态码来代理302状态码，以避免302状态码被覆盖。

### 4.客户端错误状态码400~499
服务器收到无法处理的内容时的响应。


- 状态码	原因短语	含义

- 400 Bad Request	语法或者请求参数有误，服务器无法理解。除非进行修改，否则客户端不会重复发送错误请求。

- 401 Unauthorized	当前请求需要用户验证。该响应必须包含一个适用于被请求资源的 WWW-Authenticate 信息头用以询问用户信息。客户端可以重复提交一个包含恰当的 Authorization 头信息的请求。如果当前请求已经包含了 Authorization 证书，那么401响应代表着服务器验证已经拒绝了那些证书。

- 402 Payment Required
该状态码是为了将来可能的需求而预留的。

- 403 Forbidden	服务器已经理解请求，但是拒绝执行它。与401响应不同的是，身份验证并不能提供任何帮助，而且这个请求也不应该被重复提交。如果这不是一个 HEAD 请求，而且服务器希望能够讲清楚为何请求不能被执行，那么就应该在实体内描述拒绝的原因。

- 404	Not Found	服务器无法找到请求的URl，通常包含一个实体，显示给客户端。

- 405	Method Not Allowed	发送的请求中带有URl不支持的方法。其在响应中应该包含Allow首部，告知该资源可以使用的方法。

- 406	Not Acceptable	在没有客户端可接受的URL相匹配的资源时使用，客户端可以指定参数来说明它们愿意接受的实体类型。

- 407	Proxy Authentication Required	类似401，但是用于对要求对资源进行认证的代理服务器。

- 408	Request Timeout	客户端完成请求的时间超时，服务器发送此状态码并关闭连接。



###5.服务器错误状态码500~599
客户端的请求有效，但是服务器出错时，可以使用，这是通常是代理与服务器交流的结果。


- 状态码	原因短语	含义

- 500	Internal Server Error	服务器遇到一个妨碍它为请求提供服务的时候使用。

- 501	Not Implemented 服务器不支持当前请求所需要的某个功能。当服务器无法识别请求的方法，并且无法支持其对任何资源的请求。

- 502	Bad Gateway	作为网关或者代理工作的服务器尝试执行请求时，从上游服务器接收到无效的响应。

- 503	Sevice Unavailable	由于临时的服务器维护或者过载，服务器当前无法处理请求。这个状况是临时的，并且将在一段时间以后恢复。如果能够预计延迟时间，那么响应中可以包含一个 Retry-After 头用以标明这个延迟时间。如果没有给出这个 Retry-After 信息，那么客户端应当以处理500响应的方式处理它。

- 504	Gateway Timeout	作为网关或者代理工作的服务器尝试执行请求时，未能及时从上游服务器（URI标识出的服务器，例如HTTP、FTP、LDAP）或者辅助服务器（例如DNS）收到响应。

- 505	HTTP Version Not Supported	服务器不支持，或者拒绝支持在请求中使用的 HTTP 版本。这暗示着服务器不能或不愿使用与客户端相同的版本。响应中应当包含一个描述了为何版本不被支持以及服务器支持哪些协议的实体。

##7.首部

首部与方法配合使用，决定服务器和客户端的动作。其有五种首部，在下面进行详细论述。

###7.1.通用首部
提供与报文相关的最基本的信息，可以由两种报文使用。信息性首部有：


```
首部	描述
Connection	允许客户端和服务器指定与请求/响应连接相关的选项
Date	提供日期和时间标志，说明报文创建的时间
MIME-Version	给出发送端使用的MIME版本
Trailer	报文采用了分块传输编码时，使用该首部列出位于报文拖挂（trailer）部分的首部集合。
Transfer-Encoding 表示输出的内容长度不能确定，普通的静态页面、图片之类的基本上都用不到这个。
但动态页面就有可能会用到，但我也注意到大部分asp,php,asp.net动态页面输出的时候大部分还是使用Content-Length，没有使用Transfer-Encoding: chunked。
不过如果结合：Content-Encoding: gzip 使用的时候，Transfer-Encoding: chunked还是比较有用的。
如果结合Transfer-Encoding: chunked使用，就不必申请一个很大的字节数组了，可以一块一块的输出，更科学，占用资源更少。
Update	给出发送端可能想要“升级”使用的新版本或者协议
Via	显示报文经过的中间节点
```

而通用缓存首部则是在HTTP/1.0中引入的，允许HTTP应用程序缓存本地副本的首部，而不用直接从服务器中获取。基本的缓存首部如下：

```
首部	描述
Cache-Control	用于随报文传送缓存指令
Pragma	另一种随报文传送指令的方式，但是非专门用于缓存
```

###7.2.请求首部
在请求报文中特有的内容。对服务器提供更详细的有关客户端的信息。其信息性首部有：


```
首部	描述
Client-IP	运行客户端的机器的IP
Host	请求的服务器主机名和端口号
Referer	当前页面的来源页面
UA-Color	提供了与客户端显示器对颜色的支持的有关信息
UA-CPU	提供了客户端的CPU类型或制造商
UA-Disp	提供客户端显示器能力相关信息
UA-OS	提供客户端操作系统信息——名称及其版本
UA-Pixels	提供客户端显示器像素
User-Agent	将发起请求的应用程序名告知服务器
```
####7.2.1.Accept首部

为客户端提供将器喜好和能力告知服务器的方式，从而使得连接的两端都得益。主要的Accept首部如下：

```
首部	描述
Accept	告诉服务器能够发送那些媒体类型
Accept-Charset	...能够发送的字符集
Accept-Encoding	...能够接受的编码方式
Accept-Language	...能够发送的语言
TE	能使用那些扩展传输编码
```

#### 7.2.2.条件请求首部

为请求加上限制，要求服务器在响应之前，确保条件为真。

```
首部	描述
Expect	允许客户端列出某请求所要求的服务器行为
If-Match	如果实体标记与文档当前的实体标记匹配，则获取文档
If-Modfied-Since	除非在指定日期之后资源被修改，否则限制该请求
If-None-match	如果实体标记与文档当前的实体标记不匹配，则获取文档
If-Range	允许对文档的某个范围进行条件请求
If-Unmodified-Since	除非在指定日期之后资源没被修改，否则限制该请求
Range	如果服务器支持范围请求，请求资源的指定范围
```

#### 7.2.3.安全请求首部

对请求进行质询后者响应认证。要求客户端在获取特定资源之前，对自身进行认证，从而提高事务安全性。

```
首部	描述
Authorization	包含客户端提供给服务器，以便对其自身进行认证的数据
Cookie	传递给服务器的一个令牌，隐含安全功能
Cookie2	用来说明请求端支持的Cookie版本
```

#### 7.2.4.代理请求首部

由于代理的普遍应用而来。

```
首部	描述
Max-Forward	在通往源服务器的路径上，将请求转发给其他代理（网关）的最大次数，与TRACE一同使用
Proxy-Authorization	与同名首部功能相同，但是用于代理
Proxy-Connection	与同名首部功能相同，但是用于代理
```

### 7.3.响应首部
由响应报文使用，为客户端提供额外的信息，包括信息性首部、协商首部和安全响应首部。信息性首部如下：


```
首部	描述
Age	响应持续时间
Public	服务器为资源提供的方法列表
Retry-After	资源不可用则在该日期或者时间重试
Server	服务器应用的名称和版本
Title	HTML源端给定的标题
Warning	比原因短语详细的警告报文
```

而协商首部则是用来传递与可协商资源有关的信息。


```
首部	描述
Accept-Range	对该资源来说，服务器可以接受的范围类型
Vary	服务器查看的其他首部的列表，可能使响应变化。即由服务器决定最适合的资源版本发送给客户端
```

安全响应首部则是HTTP的质询/响应认证机制的响应侧。安全响应首部如下：


```
首部	描述
Procy-Authenticate	来自代理对客户端的质询列表
Set-Cookie	在客户端设置令牌，标识客户端
Set-Cookie2	类似上面
WWW-Authenticate	来自服务器的对客户端的质询列表
```

### 7.4.实体首部
可以出现在两种报文中，提供有关实体及其内容的大量信息，其信息性首部有：


```
首部	描述
Allow	列出对该实体可以执行的请求方法
Location	告知客户端实体的位置，用于定向到资源的位置
```

内容首部包含的是与实体内容有关的特定信息。


```
首部	描述
Content-Base	解析主体中相对URL时使用的基础URL
Content-Encoding	对主体执行的编码方式
Content-Language	理解主体适合的自然语言
Content-Length	长度
Content-Location	位置
Content-MD5	MD5校验码
Content-Range	该实体表示的字节范围
Content-Type	对象类型
```

缓存首部则说明了被缓存的主体的信息。

```
首部	描述
ETag	与实体相关的实体标记
Expires	实体不再有效，要从原始的源端中再次获取该实体的日期和时间
Last-Modified	实体最后一次被修改的日期和时间
```

### 7.5 其他首部


```
首部    描述
Upgrade-Insecure-Requests 将遗留站点升级到HTTPS：Chrome 43将启用新的内容安全策略“升级不安全请求（upgrade-insecure-requests）”，即在启用升级非安全请求后，HTTP会被作为HTTPS对待。许多传统网站的页面可能包含了HTTP资源请求，在启用HTTPS后页面的HTTP请求仍然给中间人劫持和监听留下了空间。然而网站开发者无需担心，Chrome浏览器会自动帮你完成安全升级，有兴趣的开发者可以去参考Google给出的示例。类似的安全策略在2013年发布的Firefox 23及其以后版本均开始采用。

X-(xxx) 扩展头部
```


